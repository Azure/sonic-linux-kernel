From a961464da6c88aee4d94af4038c748a1e8a1f412 Mon Sep 17 00:00:00 2001
From: Antony Rheneus <arheneus@marvell.com>
Date: Thu, 17 Oct 2019 18:57:48 +0530
Subject: [PATCH] armhf mandatory configs for boot

---
 debian/build/build_armhf_none_armmp/.config | 53 ++++++++++++++++-------------
 1 file changed, 30 insertions(+), 23 deletions(-)

diff --git a/debian/build/build_armhf_none_armmp/.config b/debian/build/build_armhf_none_armmp/.config
index e997934..69288eb 100644
--- a/debian/build/build_armhf_none_armmp/.config
+++ b/debian/build/build_armhf_none_armmp/.config
@@ -1793,16 +1793,16 @@ CONFIG_PROC_EVENTS=y
 CONFIG_MTD=y
 # CONFIG_MTD_TESTS is not set
 # CONFIG_MTD_REDBOOT_PARTS is not set
-# CONFIG_MTD_CMDLINE_PARTS is not set
+CONFIG_MTD_CMDLINE_PARTS=y
 # CONFIG_MTD_AFS_PARTS is not set
-CONFIG_MTD_OF_PARTS=m
-CONFIG_MTD_AR7_PARTS=m
+CONFIG_MTD_OF_PARTS=y
+CONFIG_MTD_AR7_PARTS=y
 
 #
 # User Modules And Translation Layers
 #
-CONFIG_MTD_BLKDEVS=m
-CONFIG_MTD_BLOCK=m
+CONFIG_MTD_BLKDEVS=y
+CONFIG_MTD_BLOCK=y
 CONFIG_MTD_BLOCK_RO=m
 # CONFIG_FTL is not set
 # CONFIG_NFTL is not set
@@ -1817,8 +1817,10 @@ CONFIG_MTD_SWAP=m
 #
 # RAM/ROM/Flash chip drivers
 #
-# CONFIG_MTD_CFI is not set
+CONFIG_MTD_CFI=y
 # CONFIG_MTD_JEDECPROBE is not set
+CONFIG_MTD_GEN_PROBE=y
+# CONFIG_MTD_CFI_ADV_OPTIONS is not set
 CONFIG_MTD_MAP_BANK_WIDTH_1=y
 CONFIG_MTD_MAP_BANK_WIDTH_2=y
 CONFIG_MTD_MAP_BANK_WIDTH_4=y
@@ -1829,6 +1831,10 @@ CONFIG_MTD_CFI_I1=y
 CONFIG_MTD_CFI_I2=y
 # CONFIG_MTD_CFI_I4 is not set
 # CONFIG_MTD_CFI_I8 is not set
+CONFIG_MTD_CFI_INTELEXT=y
+CONFIG_MTD_CFI_AMDSTD=y
+CONFIG_MTD_CFI_STAA=y
+CONFIG_MTD_CFI_UTIL=y
 CONFIG_MTD_RAM=m
 # CONFIG_MTD_ROM is not set
 # CONFIG_MTD_ABSENT is not set
@@ -1850,8 +1856,8 @@ CONFIG_MTD_PLATRAM=m
 CONFIG_MTD_DATAFLASH=m
 # CONFIG_MTD_DATAFLASH_WRITE_VERIFY is not set
 # CONFIG_MTD_DATAFLASH_OTP is not set
-CONFIG_MTD_M25P80=m
-CONFIG_MTD_SST25L=m
+CONFIG_MTD_M25P80=y
+CONFIG_MTD_SST25L=y
 # CONFIG_MTD_SLRAM is not set
 # CONFIG_MTD_PHRAM is not set
 # CONFIG_MTD_MTDRAM is not set
@@ -1878,7 +1884,7 @@ CONFIG_MTD_NAND_RICOH=m
 # CONFIG_MTD_NAND_DISKONCHIP is not set
 # CONFIG_MTD_NAND_DOCG4 is not set
 CONFIG_MTD_NAND_CAFE=m
-CONFIG_MTD_NAND_PXA3xx=m
+CONFIG_MTD_NAND_PXA3xx=y
 CONFIG_MTD_NAND_NANDSIM=m
 CONFIG_MTD_NAND_GPMI_NAND=m
 # CONFIG_MTD_NAND_BRCMNAND is not set
@@ -3824,7 +3830,7 @@ CONFIG_SENSORS_MAX1668=m
 CONFIG_SENSORS_MAX6639=m
 CONFIG_SENSORS_MAX6642=m
 CONFIG_SENSORS_MAX6650=m
-# CONFIG_SENSORS_MAX6620 is not set
+CONFIG_SENSORS_MAX6620=m
 # CONFIG_SENSORS_MAX6697 is not set
 # CONFIG_SENSORS_MAX31790 is not set
 # CONFIG_SENSORS_MCP3021 is not set
diff --git a/debian/build/build_armhf_none_armmp/.config b/debian/build/build_armhf_none_armmp/.config
index e997934..69288eb 100644
--- a/debian/build/build_armhf_none_armmp/.config
+++ b/debian/build/build_armhf_none_armmp/.config
@@ -3390,7 +3390,7 @@
 # Multiplexer I2C Chip support
 #
 CONFIG_I2C_ARB_GPIO_CHALLENGE=m
-# CONFIG_I2C_MUX_GPIO is not set
+CONFIG_I2C_MUX_GPIO=m
 # CONFIG_I2C_MUX_PCA9541 is not set
 CONFIG_I2C_MUX_PCA954x=m
 # CONFIG_I2C_MUX_PINCTRL is not set
diff --git a/drivers/i2c/busses/i2c-mv64xxx.c b/drivers/i2c/busses/i2c-mv64xxx.c
index 5c9dea7..c4e6c19 100644
--- a/drivers/i2c/busses/i2c-mv64xxx.c
+++ b/drivers/i2c/busses/i2c-mv64xxx.c
@@ -25,6 +25,7 @@
 #include <linux/clk.h>
 #include <linux/err.h>
 #include <linux/delay.h>
+#include <linux/semaphore.h>
 
 #define MV64XXX_I2C_ADDR_ADDR(val)			((val & 0x7f) << 1)
 #define MV64XXX_I2C_BAUD_DIV_N(val)			(val & 0x7)
@@ -146,6 +147,7 @@
 	bool			irq_clear_inverted;
 	/* Clk div is 2 to the power n, not 2 to the power n + 1 */
 	bool			clk_n_base_0;
+        struct semaphore        sem_lock;
 };
 
 static struct mv64xxx_i2c_regs mv64xxx_i2c_regs_mv64xxx = {
@@ -718,6 +720,9 @@
 	drv_data->msgs = msgs;
 	drv_data->num_msgs = num;
 
+        if (down_interruptible(&drv_data->sem_lock)){
+            return(-EINTR);
+        }
 	if (mv64xxx_i2c_can_offload(drv_data))
 		rc = mv64xxx_i2c_offload_xfer(drv_data);
 	else
@@ -725,6 +730,7 @@
 
 	if (rc < 0)
 		ret = rc;
+        up(&drv_data->sem_lock);
 
 	drv_data->num_msgs = 0;
 	drv_data->msgs = NULL;
@@ -863,6 +869,8 @@
 	if (of_device_is_compatible(np, "allwinner,sun6i-a31-i2c"))
 		drv_data->irq_clear_inverted = true;
 
+        dev_info(&drv_data->adapter.dev,
+                "mv64xxx: i2c adapter, clock: %dHz\n", bus_freq);
 out:
 	return rc;
 }
@@ -901,6 +909,7 @@
 
 	init_waitqueue_head(&drv_data->waitq);
 	spin_lock_init(&drv_data->lock);
+	sema_init(&drv_data->sem_lock, 1);
 
 	/* Not all platforms have a clk */
 	drv_data->clk = devm_clk_get(&pd->dev, NULL);
@@ -949,6 +958,8 @@
 			"mv64xxx: Can't add i2c adapter, rc: %d\n", -rc);
 		goto exit_free_irq;
 	}
+        dev_info(&drv_data->adapter.dev,
+                "mv64xxx: i2c adapter, sema version\n");
 
 	return 0;
 
-- 
2.18.0
